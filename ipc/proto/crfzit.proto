syntax = "proto3";

package crfzit.ipc;

// å¯¼å…¥ google.protobuf.Empty ç”¨äºæ— å‚æ•°æˆ–è¿”å›å€¼çš„RPC
// å¯¼å…¥ google.protobuf.Timestamp ç”¨äºæ—¶é—´æˆ³
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

// --- æœåŠ¡é€‰é¡¹ï¼Œç”¨äºæŒ‡å®šåŒ…å ---
option java_package = "com.crfzit.ipc";
option java_multiple_files = true;

// --- Enums: å®šä¹‰å„ç§ç­–ç•¥å’ŒçŠ¶æ€ ---

// å†»ç»“æ¨¡å¼
enum FreezeMode {
  V2_FREEZE = 0; // cgroup v2 freezer
  V1_FREEZE = 1; // cgroup v1 freezer (å…¼å®¹æ—§å†…æ ¸)
  SIGSTOP = 2;   // SIGSTOPä¿¡å·
  KILL = 3;      // æ€æ­»è¿›ç¨‹
}

// ç½‘ç»œç­–ç•¥
enum NetworkPolicy {
  NET_ALLOW_ALL = 0;  // å…è®¸æ‰€æœ‰ç½‘ç»œ
  NET_WIFI_ONLY = 1;  // ä»…å…è®¸Wi-Fi
  NET_BLOCK_ALL = 2;  // é˜»æ­¢æ‰€æœ‰ç½‘ç»œ
}

// OOM Score ä¼˜å…ˆçº§
enum OomPriority {
  OOM_HIGH = 0;   // é«˜ä¼˜å…ˆçº§ (ä¸æ˜“è¢«æ€)
  OOM_MEDIUM = 1; // ä¸­ç­‰ä¼˜å…ˆçº§
  OOM_LOW = 2;    // ä½ä¼˜å…ˆçº§ (å®¹æ˜“è¢«æ€)
}

// å‰å°è¯†åˆ«ç­–ç•¥
enum ForegroundPolicy {
  STRICT = 0;   // ä¸¥æ ¼æ¨¡å¼: ä»…æ‹¥æœ‰TopActivityæ—¶è§†ä¸ºå‰å°
  LENIENT = 1;  // å®½æ¾æ¨¡å¼: å¯æ ¹æ®å­é€‰é¡¹è±å…
}

// ä»ªè¡¨ç›˜ä¸Šæ˜¾ç¤ºçš„åº”ç”¨çŠ¶æ€æšä¸¾
enum AppDisplayStatus {
  FOREGROUND = 0;         // å‰å°
  BACKGROUND_ACTIVE = 1;  // åå°æ´»åŠ¨
  FROZEN = 2;             // å·²å†»ç»“
  KILLED = 3;             // å·²æ€æ­»/ä¼‘çœ 
  PENDING_FREEZE = 4;     // ç­‰å¾…å†»ç»“
}


// --- Messages: å®šä¹‰æ•°æ®ç»“æ„ ---

// å•ä¸ªåº”ç”¨çš„å®Œæ•´é…ç½®
message AppConfig {
  string package_name = 1;
  FreezeMode freeze_mode = 2;
  NetworkPolicy network_policy = 3;
  OomPriority oom_priority = 4;
  ForegroundPolicy foreground_policy = 5;
  bool lenient_allow_playback = 6;       // å®½æ¾æ¨¡å¼: å…è®¸åå°æ’­æ”¾
  bool lenient_allow_notification = 7;   // å®½æ¾æ¨¡å¼: å…è®¸å¸¸é©»é€šçŸ¥
  bool lenient_allow_network = 8;        // å®½æ¾æ¨¡å¼: å…è®¸é«˜é€Ÿç½‘ç»œ
  bool is_whitelisted = 9;               // æ˜¯å¦åœ¨ç™½åå• (åå°è‡ªç”±)
  bool allow_fcm_wakeup = 10;            // æ˜¯å¦å…è®¸FCMå”¤é†’
}

// ä»ªè¡¨ç›˜ä¸Šå•ä¸ªåº”ç”¨çš„å®æ—¶è¿è¡Œæ—¶çŠ¶æ€
message AppRuntimeState {
  string package_name = 1;
  AppDisplayStatus display_status = 2;
  FreezeMode active_freeze_mode = 3; // å¦‚æœæ˜¯FROZENï¼ŒæŒ‡æ˜å…·ä½“æ–¹å¼ (V2, V1, SIGSTOP)
  int64 memory_usage_kb = 4;         // å†…å­˜ä½¿ç”¨ (KB)
  float cpu_usage_percent = 5;       // CPUä½¿ç”¨ç‡ (%)
  int32 pending_freeze_sec = 6;      // å¦‚æœæ˜¯PENDING_FREEZEï¼Œå‰©ä½™ç§’æ•°
  
  // --- çŠ¶æ€æŒ‡ç¤ºå™¨å¸ƒå°”å€¼ ---
  bool is_whitelisted = 10;        // ğŸ›¡ï¸
  bool has_playback = 11;          // ğŸµ
  bool has_notification = 12;      // ğŸ””
  bool has_network_activity = 13;  // ğŸ“¡
  bool is_foreground = 14;         // â–¶ï¸
}

// ä»ªè¡¨ç›˜çš„å…¨å±€ç³»ç»ŸçŠ¶æ€
message GlobalStats {
  float total_cpu_usage_percent = 1;
  int64 total_mem_kb = 2;
  int64 avail_mem_kb = 3;
  int64 network_speed_down_bps = 4; // ä¸‹è½½é€Ÿåº¦ (bits per second)
  int64 network_speed_up_bps = 5;   // ä¸Šä¼ é€Ÿåº¦ (bits per second)
  string active_profile_name = 6;   // å½“å‰æƒ…æ™¯æ¨¡å¼åç§°
}

// äº‹ä»¶æ—¶é—´çº¿æ—¥å¿—æ¡ç›®
message EventLog {
  google.protobuf.Timestamp timestamp = 1;
  string event_description = 2;
}

// ä» system_server (Observer) å‘é€ç»™ crfzitd çš„æ¡†æ¶å±‚äº‹ä»¶
message FrameworkEvent {
  // å¾…å®šä¹‰, ä¾‹å¦‚åº”ç”¨çŠ¶æ€å˜åŒ–ã€å¹¿æ’­äº‹ä»¶ç­‰
  // v1.0 æš‚æ—¶ç•™ç©º
}

// åŒ…å«æ‰€æœ‰æ´»åŠ¨åº”ç”¨çŠ¶æ€çš„åˆ—è¡¨ï¼Œç”¨äºä¸€æ¬¡æ€§æ¨é€
message ActiveAppsStateList {
    repeated AppRuntimeState apps = 1;
}

// --- Services: å®šä¹‰RPCæ¥å£ ---

// é…ç½®ç®¡ç†æœåŠ¡
service ConfigService {
  // è®¾ç½®å•ä¸ªåº”ç”¨çš„é…ç½®
  rpc SetAppConfig(AppConfig) returns (google.protobuf.Empty);
  // è·å–æ‰€æœ‰å·²é…ç½®çš„åº”ç”¨
  rpc GetAllConfigs(google.protobuf.Empty) returns (stream AppConfig);
  // æ›´å¤šé…ç½®ç›¸å…³çš„RPC...
}

// ä»ªè¡¨ç›˜æ•°æ®æµæœåŠ¡
service DashboardService {
  // æµå¼ä¼ è¾“å…¨å±€çŠ¶æ€
  rpc StreamGlobalStats(google.protobuf.Empty) returns (stream GlobalStats);
  // æµå¼ä¼ è¾“æ´»åŠ¨åº”ç”¨çŠ¶æ€åˆ—è¡¨ (æ³¨æ„ï¼šæ­¤å¤„ä¿®æ”¹ä¸ºä¸€æ¬¡æ€§æ¨é€åˆ—è¡¨ï¼Œä»¥ç®€åŒ–å®¢æˆ·ç«¯é€»è¾‘)
  rpc StreamActiveAppsState(google.protobuf.Empty) returns (stream ActiveAppsStateList);
  // è·å–å†å²äº‹ä»¶æ—¥å¿—
  rpc GetEventLogs(google.protobuf.Empty) returns (stream EventLog);
}

// ç³»ç»Ÿäº¤äº’æœåŠ¡
service SystemService {
  // Observer ä¸ŠæŠ¥æ¡†æ¶äº‹ä»¶
  rpc ReportFrameworkEvent(FrameworkEvent) returns (google.protobuf.Empty);
  // æ›´å¤šç³»ç»Ÿçº§æ“ä½œçš„RPC...
}